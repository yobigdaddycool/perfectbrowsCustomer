<div class="wrap">
  <div class="card" role="region" aria-label="Customer Intake">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>{{ isEditMode ? 'Edit Customer' : 'Register New Customer' }}</h1>
      </div>
      <div class="badges">
        <span class="chip">{{ isEditMode ? 'Edit Mode' : 'Landing — Register' }}</span>
        <span class="chip">Angular App</span>
        <span class="chip">Magenta Theme</span>
      </div>
    </div>

    <form class="content" #customerForm="ngForm" (ngSubmit)="onSubmit()" (change)="checkFormDirty()">
      <!-- Loading state -->
      @if (isLoadingCustomer) {
        <div class="loading-state" style="text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto 20px;"></div>
          <p>Loading customer data...</p>
        </div>
      }

      <div class="grid" [style.display]="isLoadingCustomer ? 'none' : 'grid'">
        <div class="col">
          <div class="row">
            <div class="field">
              <label for="firstName" class="req">First Name</label>
              <input id="firstName" type="text" [(ngModel)]="customer.firstName" name="firstName"
                     placeholder="e.g., Ayesha" required
                     (blur)="validateField('firstName', customer.firstName)"
                     (ngModelChange)="checkFormDirty()"
                     [class.error]="fieldErrors['firstName']"
                     [class.flash-error]="isFlashing('firstName')" />
              @if (fieldErrors['firstName']) {
                <div class="error-message">
                  {{ fieldErrors['firstName'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="lastName" class="req">Last Name</label>
              <input id="lastName" type="text" [(ngModel)]="customer.lastName" name="lastName" 
                     placeholder="e.g., Khan" required 
                     (blur)="validateField('lastName', customer.lastName)"
                     [class.error]="fieldErrors['lastName']"
                     [class.flash-error]="isFlashing('lastName')" />
              @if (fieldErrors['lastName']) {
                <div class="error-message">
                  {{ fieldErrors['lastName'] }}
                </div>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="phone" class="req">Phone</label>
              <input id="phone" type="tel" [(ngModel)]="customer.phone" name="phone"
                     placeholder="(555) 123‑4567"
                     (blur)="validateField('phone', customer.phone)"
                     [class.error]="fieldErrors['phone']"
                     [class.flash-error]="isFlashing('phone')" />
              @if (fieldErrors['phone']) {
                <div class="error-message">
                  {{ fieldErrors['phone'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" [(ngModel)]="customer.email" name="email" 
                     placeholder="name@example.com" 
                     (blur)="validateField('email', customer.email)"
                     [class.error]="fieldErrors['email']"
                     [class.flash-error]="isFlashing('email')" />
              @if (fieldErrors['email']) {
                <div class="error-message">
                  {{ fieldErrors['email'] }}
                </div>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="stylist" class="req">Stylist</label>
              <select id="stylist" [(ngModel)]="customer.stylist" name="stylist" required
                      [class.error]="fieldErrors['stylist']"
                      [class.flash-error]="isFlashing('stylist')">
                <option value="" selected disabled>Select stylist…</option>
                <option>Any Available</option>
                <option>Anna</option>
                <option>Layla</option>
                <option>Maria</option>
                <option>Nora</option>
              </select>
              @if (fieldErrors['stylist']) {
                <div class="error-message">
                  {{ fieldErrors['stylist'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="visitType">Visit Type</label>
              <select id="visitType" [(ngModel)]="customer.visitType" name="visitType">
                <option>New</option>
                <option>Returning</option>
                <option>Walk‑in</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="service" class="req">Service</label>
            <select id="service" [(ngModel)]="customer.service" name="service" required
                    [class.error]="fieldErrors['service']"
                    [class.flash-error]="isFlashing('service')">
              <option value="" selected disabled>Select a service…</option>
              <option>Threading</option>
              <option>Waxing</option>
              <option>Tinting</option>
              <option>Lashes</option>
              <option>Facial</option>
            </select>
            @if (fieldErrors['service']) {
              <div class="error-message">
                {{ fieldErrors['service'] }}
              </div>
            }
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" [(ngModel)]="customer.notes" name="notes" 
                      placeholder="Allergies, preferences, reference look, etc."
                      [class.error]="fieldErrors['notes']"
                      [class.flash-error]="isFlashing('notes')"></textarea>
            <div class="help">
              {{ customer.notes.length || 0 }}/500 characters
              @if (fieldErrors['notes']) {
                <span class="error-message"> - {{ fieldErrors['notes'] }}</span>
              }
            </div>
          </div>
        </div>

        <div class="col">
          <div class="field">
            <label>Customer Photo</label>
            <div class="photo-box">
              <!-- Empty state / Placeholder -->
              @if (!cameraActive && !photoPreview && !capturedPhoto) {
                <div class="placeholder">
                  <div>
                    <div><strong>No photo captured</strong></div>
                    <div class="help">Use camera or upload a photo</div>
                  </div>
                </div>
              }

              <!-- Camera active - Live video -->
              @if (cameraActive && !photoPreview) {
                <div class="camera-container">
                  <video #videoElement autoplay playsinline class="camera-video"></video>
                </div>
              }

              <!-- Photo preview (before confirmation) -->
              @if (photoPreview) {
                <div class="photo-preview">
                  <img [src]="photoPreview" alt="Photo preview" />
                </div>
              }

              <!-- Final captured photo -->
              @if (capturedPhoto && !cameraActive) {
                <div class="photo-captured">
                  <img [src]="capturedPhoto" alt="Captured photo" />
                </div>
              }

              <!-- Hidden canvas for capturing -->
              <canvas #canvasElement style="display: none;"></canvas>
            </div>

            <!-- Button states -->
            <div class="row" style="margin-top:10px; gap: 8px;">
              <!-- Initial state buttons -->
              @if (!cameraActive && !capturedPhoto) {
                <button type="button" class="btn btn-outline" (click)="openCamera()">
                  Open Camera
                </button>
                <button type="button" class="btn btn-outline" (click)="fileInput.click()">
                  Upload Photo
                </button>
                <input #fileInput type="file" accept="image/*" style="display: none;" (change)="handleFileUpload($event)" />
              }

              <!-- Camera active, no preview yet -->
              @if (cameraActive && !photoPreview) {
                <button type="button" class="btn btn-primary" (click)="capturePhoto()">
                  Capture Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="closeCamera()">
                  Cancel
                </button>
              }

              <!-- Preview state (before confirmation) -->
              @if (photoPreview) {
                <button type="button" class="btn btn-primary" (click)="usePhoto()">
                  Use This Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="retakePhoto()">
                  Retake Photo
                </button>
              }

              <!-- Photo captured (final state) -->
              @if (capturedPhoto && !cameraActive) {
                <button type="button" class="btn btn-outline" (click)="changePhoto()">
                  Change Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="removePhoto()">
                  Remove Photo
                </button>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="date" class="req">Date</label>
              <input id="date" type="date" [(ngModel)]="customer.date" name="date"
                     (blur)="validateField('date', customer.date)"
                     [class.error]="fieldErrors['date']"
                     [class.flash-error]="isFlashing('date')" />
              @if (fieldErrors['date']) {
                <div class="error-message">
                  {{ fieldErrors['date'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="time">Time</label>
              <input id="time" type="time" [(ngModel)]="customer.time" name="time" />
            </div>
          </div>

          <div class="field">
            <label for="price">Quoted Price</label>
            <input id="price" type="number" [(ngModel)]="customer.price" name="price" 
                   inputmode="decimal" placeholder="e.g., 29.99" step="0.01"
                   (blur)="validateField('price', customer.price)"
                   [class.error]="fieldErrors['price']"
                   [class.flash-error]="isFlashing('price')" />
            @if (fieldErrors['price']) {
              <div class="error-message">
                {{ fieldErrors['price'] }}
              </div>
            }
          </div>

          <div class="field">
            <label>Consent</label>
            <div class="row" style="gap:8px">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" [(ngModel)]="customer.smsConsent" name="smsConsent" /> SMS reminders
              </label>
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" [(ngModel)]="customer.emailConsent" name="emailConsent" /> Email updates
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-outline" (click)="onClear()" [disabled]="cameraActive">Clear</button>
        <button type="submit" class="btn btn-primary" [disabled]="isLoadingCustomer || cameraActive">
          {{ isEditMode ? 'Update Customer' : 'Save Customer' }}
        </button>
      </div>

      @if (cameraActive) {
        <div class="info-message" style="text-align: center; color: #ff6b35; margin-top: 10px;">
          Please finish capturing photo before saving
        </div>
      }

      <!-- Connection Status Indicator -->
      <div class="connection-status-container">
        <div class="connection-status" [ngClass]="{
          'connected': dbConnection.connectionStatus() === 'connected',
          'disconnected': dbConnection.connectionStatus() === 'disconnected',
          'checking': dbConnection.connectionStatus() === 'checking'
        }">
          @if (dbConnection.connectionStatus() === 'connected') {
            <span class="status-dot"></span>
            <span>Database Connection Successful</span>
          } @else if (dbConnection.connectionStatus() === 'disconnected') {
            <span class="status-dot"></span>
            <span>DB Disconnected</span>
          } @else {
            <span class="status-dot"></span>
            <span>Checking connection...</span>
          }
        </div>
        <p class="subtle">Angular Application • Full form validation enabled</p>
      </div>
    </form>
  </div>
</div>

<!-- Clickable toast that disappears when clicked -->
<div class="toast" [class.show]="showToast" role="status" aria-live="polite" (click)="hideToast()">
  {{ toastMessage }}
</div>