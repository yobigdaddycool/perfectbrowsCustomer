<div class="wrap">
  <div class="card" role="region" aria-label="Customer Intake">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>{{ isEditMode ? 'Edit Customer' : 'Register New Customer' }}</h1>
      </div>
      <div class="badges">
        <span class="chip">{{ isEditMode ? 'Edit Mode' : 'Landing - Register' }}</span>
        <span class="chip">Angular App</span>
        <span class="chip">Magenta Theme</span>
      </div>
    </div>

    <form
      class="content"
      #customerForm="ngForm"
      (ngSubmit)="onSubmit()"
      (change)="checkFormDirty()"
      [class.read-only]="isReadOnlyMode"
      [attr.aria-disabled]="isReadOnlyMode ? 'true' : null">
      @if (isReadOnlyMode) {
        <div class="read-only-banner" role="alert" aria-live="polite">
          <div class="read-only-banner__title">
            Inactive customer profile
            @if (readOnlyStatusLabel) {
              <span class="read-only-banner__chip">{{ readOnlyStatusLabel }}</span>
            }
          </div>
          <p>{{ readOnlyBannerMessage }}</p>
        </div>
      }

      <!-- Loading state -->
      @if (isLoadingCustomer) {
        <div class="loading-state" style="text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto 20px;"></div>
          <p>Loading customer data...</p>
        </div>
      }

      <div class="grid" [style.display]="isLoadingCustomer ? 'none' : 'grid'">
        <div class="col">
          <div class="row">
            <div class="field">
              <label for="firstName" class="req">First Name</label>
              <input id="firstName" type="text" [(ngModel)]="customer.firstName" name="firstName"
                     placeholder="e.g., Ayesha" required
                     (blur)="validateField('firstName', customer.firstName)"
                     (ngModelChange)="checkFormDirty()"
                     [disabled]="isReadOnlyMode"
                     [class.error]="fieldErrors['firstName']"
                     [class.flash-error]="isFlashing('firstName')" />
              @if (fieldErrors['firstName']) {
                <div class="error-message">
                  {{ fieldErrors['firstName'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="lastName" class="req">Last Name</label>
              <input id="lastName" type="text" [(ngModel)]="customer.lastName" name="lastName" 
                     placeholder="e.g., Khan" required 
                     (blur)="validateField('lastName', customer.lastName)"
                     [disabled]="isReadOnlyMode"
                     [class.error]="fieldErrors['lastName']"
                     [class.flash-error]="isFlashing('lastName')" />
              @if (fieldErrors['lastName']) {
                <div class="error-message">
                  {{ fieldErrors['lastName'] }}
                </div>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="phone" class="req">Phone</label>
              <input id="phone" type="tel" [(ngModel)]="customer.phone" name="phone"
                     placeholder="(555) 123-4567"
                     (input)="formatPhoneNumber($event)"
                     (blur)="validateField('phone', customer.phone)"
                     [disabled]="isReadOnlyMode"
                     [class.error]="fieldErrors['phone']"
                     [class.flash-error]="isFlashing('phone')" />
              @if (fieldErrors['phone']) {
                <div class="error-message">
                  {{ fieldErrors['phone'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" [(ngModel)]="customer.email" name="email" 
                     placeholder="name@example.com" 
                     (blur)="validateField('email', customer.email)"
                     [disabled]="isReadOnlyMode"
                     [class.error]="fieldErrors['email']"
                     [class.flash-error]="isFlashing('email')" />
              @if (fieldErrors['email']) {
                <div class="error-message">
                  {{ fieldErrors['email'] }}
                </div>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="stylist" class="req">Stylist</label>
              <select id="stylist" [(ngModel)]="customer.stylist" name="stylist" required
                      (change)="validateField('stylist', customer.stylist)"
                      [disabled]="isReadOnlyMode"
                      [class.error]="fieldErrors['stylist']"
                      [class.flash-error]="isFlashing('stylist')">
                <option value="" disabled>Select stylist...</option>
                @for (stylist of stylists; track stylist.id) {
                  <option [value]="stylist.id">{{ stylist.name }}</option>
                }
              </select>
              @if (stylists.length === 0) {
                <div class="help">{{ isLoadingOptions ? 'Loading stylists...' : 'No stylists available' }}</div>
              }
              @if (fieldErrors['stylist']) {
                <div class="error-message">
                  {{ fieldErrors['stylist'] }}
                </div>
              }
            </div>
            <div class="field">
              <label for="visitType">Visit Type</label>
              <select id="visitType" [(ngModel)]="customer.visitType" name="visitType" [disabled]="isReadOnlyMode">
                <option>New</option>
                <option>Returning</option>
                <option>Walk-in</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="service" class="req">Service</label>
            <select id="service" [(ngModel)]="customer.service" name="service" required
                    (change)="validateField('service', customer.service)"
                    [disabled]="isReadOnlyMode"
                    [class.error]="fieldErrors['service']"
                    [class.flash-error]="isFlashing('service')">
              <option value="" disabled>Select a service...</option>
              @for (service of services; track service.id) {
                <option [value]="service.id">{{ service.name }}</option>
              }
            </select>
            @if (services.length === 0) {
              <div class="help">{{ isLoadingOptions ? 'Loading services...' : 'No services available' }}</div>
            }
            @if (fieldErrors['service']) {
              <div class="error-message">
                {{ fieldErrors['service'] }}
              </div>
            }
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" [(ngModel)]="customer.notes" name="notes"
                      placeholder="Allergies, preferences, reference look, etc."
                      [disabled]="isReadOnlyMode"
                      [class.error]="fieldErrors['notes']"
                      [class.flash-error]="isFlashing('notes')"></textarea>
            <div class="help">
              {{ customer.notes.length || 0 }}/500 characters
              @if (fieldErrors['notes']) {
                <span class="error-message"> - {{ fieldErrors['notes'] }}</span>
              }
            </div>
          </div>

          <!-- QR Code Section -->
          <div class="field">
            <label>Customer QR Code</label>
            @if (qrCodeDataUrl) {
              <div style="text-align: center; padding: 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;">
                <img [src]="qrCodeDataUrl" alt="Customer QR Code" style="max-width: 300px; width: 100%;" />
                <div class="help" style="margin-top: 10px; color: #666;">
                  Scan this code to access customer information
                </div>
                <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                  <button type="button" class="btn btn-outline" (click)="regenerateQrCode()" [disabled]="isLoadingCustomer || !customerId || isPhotoProcessing || isReadOnlyMode">
                    Regenerate QR Code
                  </button>
                  <button type="button" class="btn btn-outline" (click)="removeQrCode()" [disabled]="isLoadingCustomer || !customerId || isPhotoProcessing || isReadOnlyMode">
                    Remove QR Code
                  </button>
                </div>
                @if (qrGeneratedAtDisplay) {
                  <div class="help" style="margin-top: 8px;">Issued {{ qrGeneratedAtDisplay }}</div>
                }
              </div>
            } @else if (qrCodeError) {
              <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;">
                {{ qrCodeError }}
              </div>
            } @else {
              <div style="padding: 15px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; color: #666;">
                QR code will be generated after customer data is loaded or saved
              </div>
              @if (isEditMode && customerId) {
                <div style="margin-top: 12px; text-align: center;">
                  <button type="button" class="btn btn-outline" (click)="regenerateQrCode()" [disabled]="isLoadingCustomer || isPhotoProcessing || isReadOnlyMode">
                    Generate QR Code
                  </button>
                </div>
              }
            }
          </div>
        </div>

        <div class="col">
          <div class="field">
            <label>Customer Photo</label>
            <div class="photo-box">
              <!-- Empty state / Placeholder -->
              @if (!cameraActive && !photoPreview && !capturedPhoto) {
                <div class="placeholder">
                  <div>
                    <div><strong>No photo captured</strong></div>
                    <div class="help">Use camera or upload a photo</div>
                  </div>
                </div>
              }

              <!-- Camera active - Live video -->
                @if (cameraActive && !photoPreview) {
                  <div class="camera-container">
                    <video #videoElement autoplay playsinline class="camera-video"></video>
                    <button
                      type="button"
                      class="camera-toggle-btn"
                      (click)="toggleCameraFacing()"
                      [disabled]="isSwitchingCamera || isReadOnlyMode"
                      aria-label="Switch camera"
                      title="Switch camera">
                      <span aria-hidden="true">&#8635;</span>
                    </button>
                  </div>
                }

                <!-- Photo preview (before confirmation) -->
                @if (photoPreview) {
                <div class="photo-preview">
                  <img [src]="photoPreview" alt="Photo preview" />
                </div>
              }

              <!-- Final captured photo -->
              @if (capturedPhoto && !cameraActive) {
                <div class="photo-captured">
                  <img [src]="capturedPhoto" alt="Captured photo" />
                </div>
              }

              <!-- Hidden canvas for capturing -->
              <canvas #canvasElement style="display: none;"></canvas>

              @if (isPhotoProcessing) {
                <div class="processing-overlay" aria-live="polite">
                  <div class="spinner small"></div>
                  <span>Saving changes...</span>
                </div>
              }
            </div>

            <!-- Button states -->
            <div class="row" style="margin-top:10px; gap: 8px;">
              <!-- Initial state buttons -->
              @if (!cameraActive && !photoPreview && !capturedPhoto) {
                <button type="button" class="btn btn-outline" (click)="openCamera()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Open Camera
                </button>
                <button type="button" class="btn btn-outline" (click)="fileInput.click()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Upload Photo
                </button>
                <input #fileInput type="file" accept="image/*" style="display: none;" (change)="handleFileUpload($event)" [disabled]="isReadOnlyMode" />
              }

              <!-- Camera active, no preview yet -->
              @if (cameraActive && !photoPreview) {
                <button type="button" class="btn btn-primary" (click)="capturePhoto()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Capture Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="closeCamera()" [disabled]="isPhotoProcessing">
                  Cancel
                </button>
              }

              <!-- Preview state (before confirmation) -->
              @if (photoPreview) {
                <button type="button" class="btn btn-primary" (click)="usePhoto()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Use This Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="retakePhoto()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Retake Photo
                </button>
              }

              <!-- Photo captured (final state) -->
              @if (capturedPhoto && !cameraActive) {
                <button type="button" class="btn btn-outline" (click)="changePhoto()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Change Photo
                </button>
                <button type="button" class="btn btn-outline" (click)="removePhoto()" [disabled]="isPhotoProcessing || isReadOnlyMode">
                  Remove Photo
                </button>
              }
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="date" class="req">Date</label>
              <input id="date" type="date" [(ngModel)]="customer.date" name="date"
                     [min]="minDate"
                     (blur)="validateField('date', customer.date)"
                     [disabled]="isReadOnlyMode"
                     [class.error]="fieldErrors['date']"
                     [class.flash-error]="isFlashing('date')" />
              @if (fieldErrors['date']) {
                <div class="error-message">
                  {{ fieldErrors['date'] }}
                </div>
              }
              <div class="help">Date cannot be more than one day in the past.</div>
            </div>
            <div class="field">
              <label for="time">Time</label>
              <input id="time" type="time" [(ngModel)]="customer.time" name="time" [disabled]="isReadOnlyMode" />
              <div class="help">Optional; leave blank if the appointment time is TBD.</div>
            </div>
          </div>

          <div class="field">
            <label for="price">Quoted Price</label>
            <input id="price" type="number" [(ngModel)]="customer.price" name="price" 
                   inputmode="decimal" placeholder="e.g., 29.99" step="0.01"
                   (blur)="validateField('price', customer.price)"
                   [disabled]="isReadOnlyMode"
                   [class.error]="fieldErrors['price']"
                   [class.flash-error]="isFlashing('price')" />
            @if (fieldErrors['price']) {
              <div class="error-message">
                {{ fieldErrors['price'] }}
              </div>
            }
          </div>

          <div class="field">
            <label>Consent</label>
            <div class="row" style="gap:8px">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" [(ngModel)]="customer.smsConsent" name="smsConsent" [disabled]="isReadOnlyMode" /> SMS reminders
              </label>
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" [(ngModel)]="customer.emailConsent" name="emailConsent" [disabled]="isReadOnlyMode" /> Email updates
              </label>
            </div>
            <div class="help">Used only for appointment reminders and occasional follow-up updates.</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button
          *ngIf="isEditMode; else clearButton"
          type="button"
          class="btn btn-outline"
          (click)="onRevert()"
          [disabled]="cameraActive || isLoadingCustomer || isPhotoProcessing || !isFormDirty || isReadOnlyMode">
          Revert Changes
        </button>
        <ng-template #clearButton>
          <button
            type="button"
            class="btn btn-outline"
            (click)="onClear()"
            [disabled]="cameraActive || isPhotoProcessing || isReadOnlyMode">
            Clear
          </button>
        </ng-template>

        <button type="submit" class="btn btn-primary" [disabled]="isLoadingCustomer || cameraActive || isPhotoProcessing || isReadOnlyMode">
          {{ isEditMode ? 'Update Customer' : 'Save Customer' }}
        </button>
      </div>

      @if (lastErrorDetails) {
        <div class="error-panel" role="region" aria-live="polite">
          <div class="error-panel__header">
            <strong>Debug details</strong>
            <button type="button" class="btn btn-link" (click)="toggleErrorDetails()">
              {{ showErrorDetails ? 'Hide Details' : 'View Details' }}
            </button>
          </div>
          @if (showErrorDetails) {
            <pre class="error-panel__body">{{ lastErrorDetails }}</pre>
          }
        </div>
      }

      @if (cameraActive) {
        <div class="info-message" style="text-align: center; color: #ff6b35; margin-top: 10px;">
          Please finish capturing photo before saving
        </div>
      }

      <!-- Connection Status Indicator -->
      <div class="connection-status-container">
        <div class="connection-status" [ngClass]="{
          'connected': dbConnection.connectionStatus() === 'connected',
          'disconnected': dbConnection.connectionStatus() === 'disconnected',
          'checking': dbConnection.connectionStatus() === 'checking'
        }">
          @if (dbConnection.connectionStatus() === 'connected') {
            <span class="status-dot"></span>
            <span>Database Connection Successful</span>
          } @else if (dbConnection.connectionStatus() === 'disconnected') {
            <span class="status-dot"></span>
            <span>DB Disconnected</span>
          } @else {
            <span class="status-dot"></span>
            <span>Checking connection...</span>
          }
        </div>
        <p class="subtle">Angular Application &bull; Full form validation enabled</p>
      </div>
    </form>
  </div>
</div>

<!-- Clickable toast that disappears when clicked -->
<div class="toast" [class.show]="showToast" role="status" aria-live="polite" (click)="hideToast()">
  {{ toastMessage }}
</div>


