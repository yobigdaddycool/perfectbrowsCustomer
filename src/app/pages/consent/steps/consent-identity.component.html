<form class="step-card" (ngSubmit)="handleContinue()">
  <header class="step-header">
    <h2>Confirm Your Identity</h2>
    <p>Please provide your contact details so we can match your consent to your Perfect Brow profile.</p>
  </header>

  @if (matchedCustomer) {
    <div class="match-banner" role="status">
      <div class="match-banner-title">Customer found</div>
      <div class="match-banner-body">
        <span class="match-banner-name">{{ matchedCustomer.first_name }} {{ matchedCustomer.last_name }}</span>
        <span class="match-banner-detail">Phone: {{ matchedCustomer.phone }}</span>
        @if (matchedCustomer.email) {
          <span class="match-banner-detail">Email: {{ matchedCustomer.email }}</span>
        }
      </div>
      <p class="match-banner-note">Review the info above, then press Continue to use this profile.</p>
    </div>
  }

  <div class="field-grid">
    <label class="field">
      <span>First Name <sup>*</sup></span>
      <input type="text" name="firstName" [(ngModel)]="form.firstName" required placeholder="e.g., Amy" />
    </label>
    <label class="field">
      <span>Last Name <sup>*</sup></span>
      <input type="text" name="lastName" [(ngModel)]="form.lastName" required placeholder="e.g., David" />
    </label>
  </div>

  <label class="field">
    <span>Mobile Phone <sup>*</sup></span>
    <input type="tel" name="phone" [(ngModel)]="form.phone" required placeholder="(555) 123-4567" (input)="formatPhoneNumber($event)" />
    <small class="hint">We use this to match your profile and send appointment updates.</small>
  </label>

  <label class="field">
    <span>Email (optional)</span>
    <input type="email" name="email" [(ngModel)]="form.email" placeholder="name@example.com" (blur)="validateEmail()" />
    <small class="hint">If provided, a verification code will be delivered here.</small>
    @if (emailError) {
      <small class="error">{{ emailError }}</small>
    }
  </label>

  <!-- Customer Match Cards -->
  @if (showMatchCards && customerMatches.length > 0) {
    <div class="match-section">
      <h3 class="match-heading">Is this you?</h3>
      <p class="match-subtitle">We found existing profile(s) with the same phone number. Please select your profile or create a new one.</p>

      <div class="match-cards">
        @for (match of customerMatches; track match.customer_id) {
          <div class="match-card" (click)="selectMatch(match.customer_id)">
            <div class="match-card-content">
              <div class="match-name">{{ match.first_name }} {{ match.last_name }}</div>
              <div class="match-details">
                <div class="match-detail">üìû {{ match.phone }}</div>
                @if (match.email) {
                  <div class="match-detail">‚úâÔ∏è {{ match.email }}</div>
                }
              </div>
            </div>
            <div class="match-card-action">
              <span class="match-select-btn">Select</span>
            </div>
          </div>
        }
      </div>

      <button type="button" class="btn-secondary" (click)="proceedAsNew()">
        None of these - Create New Profile
      </button>
    </div>
  }

  <footer class="step-footer">
    @if (isLoadingMatches) {
      <button type="button" class="btn-primary" disabled>
        <span class="spinner-small"></span> Checking...
      </button>
    } @else if (matchedCustomer) {
      <button type="submit" class="btn-primary">Use This Profile &amp; Continue</button>
    } @else {
      <button type="submit" class="btn-primary">Continue</button>
    }
  </footer>
</form>
